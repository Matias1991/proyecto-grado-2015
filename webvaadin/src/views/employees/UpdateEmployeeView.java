package views.employees;

import java.util.Collection;

import utils.PopupWindow;
import views.BaseView;

import com.example.webvaadin.WebvaadinUI;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.data.util.BeanItem;
import com.vaadin.data.util.BeanItemContainer;
import com.vaadin.data.util.converter.StringToDoubleConverter;
import com.vaadin.data.util.converter.StringToIntegerConverter;
import com.vaadin.data.util.filter.SimpleStringFilter;
import com.vaadin.data.validator.EmailValidator;
import com.vaadin.event.SelectionEvent;
import com.vaadin.event.FieldEvents.TextChangeEvent;
import com.vaadin.event.FieldEvents.TextChangeListener;
import com.vaadin.event.SelectionEvent.SelectionListener;
import com.vaadin.navigator.ViewChangeListener.ViewChangeEvent;
import com.vaadin.ui.AbsoluteLayout;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.ComboBox;
import com.vaadin.ui.Grid;
import com.vaadin.ui.Grid.HeaderCell;
import com.vaadin.ui.Grid.HeaderRow;
import com.vaadin.ui.Grid.SelectionMode;
import com.vaadin.ui.GridLayout;
import com.vaadin.ui.Label;
import com.vaadin.ui.OptionGroup;
import com.vaadin.ui.TabSheet;
import com.vaadin.ui.TextField;

import controllers.EmployeeController;
import entities.Category;
import entities.Employee;
import entities.RequestContext;
import entities.SalarySummary;

public class UpdateEmployeeView extends BaseView {

	@AutoGenerated
	private AbsoluteLayout mainLayout;
	@AutoGenerated
	private TabSheet tabEmployee;
	@AutoGenerated
	private Label lblTitle;
	private Grid updateEmployeesGrid;
	private BeanItemContainer<Employee> beanContainer;
	private TextField txtName;
	private TextField txtSurname;
	private TextField txtEmail;
	private TextField txtAddress;
	private TextField txtCellphone;
	private TextField txtNominalSalary;
	private TextField txtTickets;
	private ComboBox cboPercentagePersonalFonasaContribution;
	private TextField txtRet;
	private TextField txtIrpf;
	private TextField txtBse;
	private TextField txtHours;
	private TextField txtCostSaleHour;
	private TextField txtPersonalRetirementContribution;
	private TextField txtEmployerRetirementContribution;
	private TextField txtPersonalFrlContribution;
	private TextField txtEmployerFrlContribution;
	private TextField txtPersonalFonasaContribution;
	private TextField txtEmployerFonasaContribution;
	private TextField txtTicketsEmployer;
	private TextField txtTotalDiscounts;
	private TextField txtTotalEmployersContribution;
	private TextField txtNominalWithoutContribution;
	private TextField txtDismisalPrevension;
	private TextField txtIncidenceSalary;
	private TextField txtSalaryToPay;
	private TextField txtCostMonth;
	private TextField txtCostRealHour;
	private TextField txtIncidenceTickets;
	private Label lblMessage;
	private OptionGroup optEmployeeType;
	private Button btnModiffy;
	private Button btnEstimate;
	private Button btnCancel;

	/**
	 * The constructor should first build the main layout, set the composition
	 * root and then do any custom initialization.
	 *
	 * The constructor will not be automatically regenerated by the visual
	 * editor.
	 */
	public UpdateEmployeeView() {
		buildMainLayout();
		buildTabSeet();
		setCompositionRoot(mainLayout);

		// TODO add user code here
		lblMessage = new Label("");
		mainLayout.addComponent(lblMessage, "top:80.0px;left:0.0px;");

		btnEstimate.addClickListener(new Button.ClickListener() {

			@Override
			public void buttonClick(ClickEvent event) {
				// TODO Auto-generated method stub
				if (validateEstimateEmployee()) {
					SalarySummary estimateSalarySummary = new SalarySummary();
					estimateSalarySummary
							.setNominalSalary((Double) txtNominalSalary
									.getConvertedValue());
					estimateSalarySummary.setTickets((Double) txtTickets
							.getConvertedValue());
					if (txtRet.getConvertedValue() == null) {
						txtRet.setConvertedValue(0.0);
					}
					estimateSalarySummary.setRET((Double) txtRet
							.getConvertedValue());
					if (txtIrpf.getConvertedValue() == null) {
						txtIrpf.setConvertedValue(0.0);
					}
					estimateSalarySummary.setIRPF((Double) txtIrpf
							.getConvertedValue());
					if (txtBse.getConvertedValue() == null) {
						txtBse.setConvertedValue(0.0);
					}
					estimateSalarySummary.setBSE((Double) txtBse
							.getConvertedValue());
					estimateSalarySummary.setHours((Integer) txtHours
							.getConvertedValue());
					if (txtCostSaleHour.getConvertedValue() == null) {
						txtCostSaleHour.setConvertedValue(0.0);
					}
					estimateSalarySummary.setCostSaleHour(Double
							.parseDouble(txtCostSaleHour.getConvertedValue()
									.toString()));
					// estimateSalarySummary.setPercentageTypeFONASA((Double.parseDouble(cboPercentagePersonalFonasaContribution.getValue().toString()))/100);
					estimateSalarySummary
							.setPercentageTypeFONASA((Double) cboPercentagePersonalFonasaContribution
									.getValue() / 100);

					SalarySummary aux = EmployeeController
							.estimateEmployee(estimateSalarySummary);
					if (aux != null) {
						changeReadOnlyState(false);

						txtNominalSalary.setConvertedValue(aux
								.getNominalSalary());
						txtTickets.setConvertedValue(aux.getTickets());
						txtRet.setConvertedValue(aux.getRET());
						txtIrpf.setConvertedValue(aux.getIRPF());
						txtBse.setConvertedValue(aux.getBSE());
						txtHours.setConvertedValue(aux.getHours());
						txtCostSaleHour.setConvertedValue(aux.getCostSaleHour());
						txtPersonalRetirementContribution.setConvertedValue(aux
								.getPersonalRetirementContribution());
						txtEmployerRetirementContribution.setConvertedValue(aux
								.getEmployersContributionsRetirement());
						txtPersonalFrlContribution.setConvertedValue(aux
								.getPersonalFRLContribution());
						txtEmployerFrlContribution.setConvertedValue(aux
								.getEmployersFRLContribution());
						txtPersonalFonasaContribution.setConvertedValue(aux
								.getPersonalFONASAContribution());
						txtEmployerFonasaContribution.setConvertedValue(aux
								.getEmployersFONASAContribution());
						txtTicketsEmployer.setConvertedValue(aux
								.getTicketsEmployers());
						txtTotalDiscounts.setConvertedValue(aux
								.getTotalDiscounts());
						txtTotalEmployersContribution.setConvertedValue(aux
								.getTotalEmployerContributions());
						txtNominalWithoutContribution.setConvertedValue(aux
								.getNominalWithoutContributions());
						txtDismisalPrevension.setConvertedValue(aux
								.getDismissalPrevention());
						txtIncidenceSalary.setConvertedValue(aux
								.getIncidenceSalary());
						txtSalaryToPay.setConvertedValue(aux.getSalaryToPay());
						txtCostMonth.setConvertedValue(aux.getCostMonth());
						txtCostRealHour.setConvertedValue(aux.getCostRealHour());
						txtIncidenceTickets.setConvertedValue(aux
								.getIncidenceTickets());
						cboPercentagePersonalFonasaContribution.setValue(aux
								.getPercentageTypeFONASA() * 100);

						changeReadOnlyState(true);
						tabEmployee.setSelectedTab(1);
					} else {
						PopupWindow notification = new PopupWindow("ERROR",
								"No se pudo estimar");
					}

				}

			}
		});

		btnModiffy.addClickListener(new Button.ClickListener() {

			@Override
			public void buttonClick(ClickEvent event) {
				// TODO Auto-generated method stub
				btnModiffy.setEnabled(false);
				if (validateUpdateEmployee()) {
					Employee updateEmployee = new Employee();
					updateEmployee.setName(txtName.getValue());
					updateEmployee.setLastName(txtSurname.getValue());
					updateEmployee.setAddress(txtAddress.getValue());
					updateEmployee.setEmail(txtEmail.getValue());
					updateEmployee.setCellPhone(txtCellphone.getValue());
					updateEmployee.setEmployedType(optEmployeeType.getValue()
							.toString());

					SalarySummary updateSalarySummary = new SalarySummary();
					updateSalarySummary
							.setNominalSalary((Double) txtNominalSalary
									.getConvertedValue());
					updateSalarySummary.setTickets((Double) txtTickets
							.getConvertedValue());
					if (txtRet.getConvertedValue() == null) {
						txtRet.setConvertedValue(0.0);
					}
					updateSalarySummary.setRET((Double) txtRet
							.getConvertedValue());
					if (txtIrpf.getConvertedValue() == null) {
						txtIrpf.setConvertedValue(0.0);
					}
					updateSalarySummary.setIRPF((Double) txtIrpf
							.getConvertedValue());
					if (txtBse.getConvertedValue() == null) {
						txtBse.setConvertedValue(0.0);
					}
					updateSalarySummary.setBSE((Double) txtBse
							.getConvertedValue());
					updateSalarySummary.setHours((Integer) txtHours
							.getConvertedValue());
					if (txtCostSaleHour.getConvertedValue() == null) {
						txtCostSaleHour.setConvertedValue(0.0);
					}
					updateSalarySummary
							.setCostSaleHour((Double) txtCostSaleHour
									.getConvertedValue());
					updateSalarySummary.setPercentageTypeFONASA((Double
							.parseDouble(cboPercentagePersonalFonasaContribution
									.getConvertedValue().toString())) / 100);

					updateEmployee.setSalarySummary(updateSalarySummary);

					if (EmployeeController.UpdateEmployee(beanContainer
							.getItem(updateEmployeesGrid.getSelectedRow())
							.getBean().getId(), updateEmployee)) {
						PopupWindow popup = new PopupWindow("AVISO",
								"Empleado actualizado correctamente");
						updateEmployeesGrid.select(null);
						mainLayout.removeComponent(updateEmployeesGrid);
						buildGrid();
						tabEmployee.setSelectedTab(0);
						tabEmployee.setVisible(false);
						btnModiffy.setEnabled(false);
					}
				}
				btnModiffy.setEnabled(true);
			}
		});

		btnCancel.addClickListener(new Button.ClickListener() {

			@Override
			public void buttonClick(ClickEvent event) {
				// TODO Auto-generated method stub
				getUI().getNavigator().navigateTo(WebvaadinUI.MAINMENU);
			}
		});
	}

	public boolean validateEstimateEmployee() {
		boolean result = true;

		if (!txtNominalSalary.isValid()) {
			result = false;
			txtNominalSalary.setRequiredError("Es requerido");
			txtNominalSalary.setConversionError("Debe ser numérico");
		}
		if (!txtTickets.isValid()) {
			result = false;
			txtTickets.setRequiredError("Es requerido");
			txtTickets.setConversionError("Debe ser numérico");
		}
		if (!cboPercentagePersonalFonasaContribution.isValid()) {
			result = false;
			cboPercentagePersonalFonasaContribution
					.setRequiredError("Es requerido");
			cboPercentagePersonalFonasaContribution
					.setConversionError("Debe ser numérico entre 0 y 100");
		}
		if (!txtHours.isValid()) {
			result = false;
			txtHours.setRequiredError("Es requerido");
			txtHours.setConversionError("Debe ser numérico");
		}
		if (!txtIrpf.isValid()) {
			result = false;
			txtIrpf.setConversionError("Debe ser numérico");
		}
		if (!txtBse.isValid()) {
			result = false;
			txtBse.setConversionError("Debe ser numérico");
		}
		if (!txtRet.isValid()) {
			result = false;
			txtRet.setConversionError("Debe ser numérico");
		}
		if (!txtCostSaleHour.isValid()) {
			result = false;
			txtCostSaleHour.setConversionError("Debe ser numérico");
		}

		return result;
	}

	public boolean validateUpdateEmployee() {
		boolean validate = validateEstimateEmployee();

		if (!txtName.isValid()) {
			validate = false;
			txtName.setRequiredError("Es requerido");
		}
		if (!txtSurname.isValid()) {
			validate = false;
			txtSurname.setRequiredError("Es requerido");
		}
		if (!txtNominalSalary.isValid()) {
			validate = false;
			txtNominalSalary.setRequiredError("Es requerido");
		}
		if (!txtTickets.isValid()) {
			validate = false;
			txtTickets.setRequiredError("Es requerido");
		}
		if (!cboPercentagePersonalFonasaContribution.isValid()) {
			validate = false;
			cboPercentagePersonalFonasaContribution
					.setRequiredError("Es requerido");
		}
		if (!txtHours.isValid()) {
			validate = false;
			txtHours.setRequiredError("Es requerido");
		}
		if (!txtEmail.isValid()) {
			validate = false;
		}
		return validate;
	}

	public void buildTabSeet() {
		// txtName
		txtName = new TextField();
		txtName.setCaption("Nombre");
		txtName.setImmediate(true);
		txtName.setWidth("390px");
		txtName.setHeight("-1px");
		txtName.setRequired(true);

		// txtSurname
		txtSurname = new TextField();
		txtSurname.setCaption("Apellido");
		txtSurname.setImmediate(true);
		txtSurname.setWidth("390px");
		txtSurname.setHeight("-1px");
		txtSurname.setRequired(true);

		// Email
		txtEmail = new TextField();
		txtEmail.setCaption("Correo electrónico");
		txtEmail.setImmediate(true);
		txtEmail.setWidth("390px");
		txtEmail.setHeight("-1px");
		txtEmail.addValidator(new EmailValidator("Formato inválido"));

		// Direccion
		txtAddress = new TextField();
		txtAddress.setCaption("Dirección");
		txtAddress.setImmediate(false);
		txtAddress.setWidth("390px");
		txtAddress.setHeight("-1px");

		// Celular
		txtCellphone = new TextField();
		txtCellphone.setCaption("Celular");
		txtCellphone.setImmediate(false);
		txtCellphone.setWidth("-1px");
		txtCellphone.setHeight("-1px");

		// Sueldo Nominal
		txtNominalSalary = new TextField();
		txtNominalSalary.setCaption("Sueldo Nominal");
		txtNominalSalary.setImmediate(false);
		txtNominalSalary.setWidth("-1px");
		txtNominalSalary.setHeight("-1px");
		txtNominalSalary.setNullRepresentation("");
		txtNominalSalary.setConverter(new StringToDoubleConverter());
		txtNominalSalary.setRequired(true);

		// Tickets
		txtTickets = new TextField();
		txtTickets.setCaption("Tickets");
		txtTickets.setImmediate(false);
		txtTickets.setWidth("-1px");
		txtTickets.setHeight("-1px");
		txtTickets.setNullRepresentation("");
		txtTickets.setConverter(new StringToDoubleConverter());
		txtTickets.setRequired(true);

		// RET
		txtRet = new TextField();
		txtRet.setCaption("RET");
		txtRet.setImmediate(false);
		txtRet.setWidth("-1px");
		txtRet.setHeight("-1px");
		txtRet.setNullRepresentation("");
		txtRet.setConverter(new StringToDoubleConverter());

		// IRPF
		txtIrpf = new TextField();
		txtIrpf.setCaption("IRPF");
		txtIrpf.setImmediate(false);
		txtIrpf.setWidth("-1px");
		txtIrpf.setHeight("-1px");
		txtIrpf.setNullRepresentation("");
		txtIrpf.setConverter(new StringToDoubleConverter());

		// BSE
		txtBse = new TextField();
		txtBse.setCaption("BSE");
		txtBse.setImmediate(false);
		txtBse.setWidth("-1px");
		txtBse.setHeight("-1px");
		txtBse.setNullRepresentation("");
		txtBse.setConverter(new StringToDoubleConverter());

		// Horas mensuales
		txtHours = new TextField();
		txtHours.setCaption("Cantidad Horas Mensual");
		txtHours.setImmediate(false);
		txtHours.setWidth("-1px");
		txtHours.setHeight("-1px");
		txtHours.setNullRepresentation("");
		txtHours.setConverter(new StringToIntegerConverter());
		txtHours.setRequired(true);

		// Precio de venta por hora
		txtCostSaleHour = new TextField();
		txtCostSaleHour.setCaption("Costo hora Venta");
		txtCostSaleHour.setImmediate(false);
		txtCostSaleHour.setWidth("-1px");
		txtCostSaleHour.setHeight("-1px");
		txtCostSaleHour.setNullRepresentation("");
		txtCostSaleHour.setConverter(new StringToDoubleConverter());

		// Porcentaje aporte FONASA Personal
		cboPercentagePersonalFonasaContribution = new ComboBox();
		cboPercentagePersonalFonasaContribution
				.setCaption("% Aporte FONASA Personal");
		cboPercentagePersonalFonasaContribution.setImmediate(false);
		cboPercentagePersonalFonasaContribution.setWidth("-1px");
		cboPercentagePersonalFonasaContribution.setHeight("-1px");
		cboPercentagePersonalFonasaContribution.setRequired(true);
		cboPercentagePersonalFonasaContribution.addItems(Double.valueOf("2"));
		cboPercentagePersonalFonasaContribution.addItems(Double.valueOf("3"));
		cboPercentagePersonalFonasaContribution.addItems(Double.valueOf("4.5"));
		cboPercentagePersonalFonasaContribution.addItems(Double.valueOf("5"));
		cboPercentagePersonalFonasaContribution.addItems(Double.valueOf("6"));
		cboPercentagePersonalFonasaContribution.addItems(Double.valueOf("8"));

		// Aporte Jubilatorio Personal
		txtPersonalRetirementContribution = new TextField();
		txtPersonalRetirementContribution
				.setCaption("Aporte Jubilatorio Personal");
		txtPersonalRetirementContribution.setImmediate(false);
		txtPersonalRetirementContribution.setWidth("-1px");
		txtPersonalRetirementContribution.setHeight("-1px");
		txtPersonalRetirementContribution.setNullRepresentation("");
		txtPersonalRetirementContribution
				.setConverter(new StringToDoubleConverter());

		// Aporte Jubilatorio Patronal
		txtEmployerRetirementContribution = new TextField();
		txtEmployerRetirementContribution
				.setCaption("Aporte Jubilatorio Patronal");
		txtEmployerRetirementContribution.setImmediate(false);
		txtEmployerRetirementContribution.setWidth("-1px");
		txtEmployerRetirementContribution.setHeight("-1px");
		txtEmployerRetirementContribution.setNullRepresentation("");
		txtEmployerRetirementContribution
				.setConverter(new StringToDoubleConverter());

		// Aporte FRL Personal
		txtPersonalFrlContribution = new TextField();
		txtPersonalFrlContribution.setCaption("Aporte FRL Personal");
		txtPersonalFrlContribution.setImmediate(false);
		txtPersonalFrlContribution.setWidth("-1px");
		txtPersonalFrlContribution.setHeight("-1px");
		txtPersonalFrlContribution.setNullRepresentation("");
		txtPersonalFrlContribution.setConverter(new StringToDoubleConverter());

		// Aporte FRL Patronal
		txtEmployerFrlContribution = new TextField();
		txtEmployerFrlContribution.setCaption("Aporte FRL Patronal");
		txtEmployerFrlContribution.setImmediate(false);
		txtEmployerFrlContribution.setWidth("-1px");
		txtEmployerFrlContribution.setHeight("-1px");
		txtEmployerFrlContribution.setNullRepresentation("");
		txtEmployerFrlContribution.setConverter(new StringToDoubleConverter());

		// Aporte FONASA Personal
		txtPersonalFonasaContribution = new TextField();
		txtPersonalFonasaContribution.setCaption("Aporte FONASA Personal");
		txtPersonalFonasaContribution.setImmediate(false);
		txtPersonalFonasaContribution.setWidth("-1px");
		txtPersonalFonasaContribution.setHeight("-1px");
		txtPersonalFonasaContribution.setNullRepresentation("");
		txtPersonalFonasaContribution
				.setConverter(new StringToDoubleConverter());

		// Aporte FONASA Patronal
		txtEmployerFonasaContribution = new TextField();
		txtEmployerFonasaContribution.setCaption("Aporte FONASA Patronal");
		txtEmployerFonasaContribution.setImmediate(false);
		txtEmployerFonasaContribution.setWidth("-1px");
		txtEmployerFonasaContribution.setHeight("-1px");
		txtEmployerFonasaContribution.setNullRepresentation("");
		txtEmployerFonasaContribution
				.setConverter(new StringToDoubleConverter());

		// Tickets Patronal
		txtTicketsEmployer = new TextField();
		txtTicketsEmployer.setCaption("Tickets Patronal");
		txtTicketsEmployer.setImmediate(false);
		txtTicketsEmployer.setWidth("-1px");
		txtTicketsEmployer.setHeight("-1px");
		txtTicketsEmployer.setNullRepresentation("");
		txtTicketsEmployer.setConverter(new StringToDoubleConverter());

		// Total Descuentos
		txtTotalDiscounts = new TextField();
		txtTotalDiscounts.setCaption("Total Descuentos");
		txtTotalDiscounts.setImmediate(false);
		txtTotalDiscounts.setWidth("-1px");
		txtTotalDiscounts.setHeight("-1px");
		txtTotalDiscounts.setNullRepresentation("");
		txtTotalDiscounts.setConverter(new StringToDoubleConverter());

		// Total Aportes Patronales
		txtTotalEmployersContribution = new TextField();
		txtTotalEmployersContribution.setCaption("Total Aportes Patronales");
		txtTotalEmployersContribution.setImmediate(false);
		txtTotalEmployersContribution.setWidth("-1px");
		txtTotalEmployersContribution.setHeight("-1px");
		txtTotalEmployersContribution.setNullRepresentation("");
		txtTotalEmployersContribution
				.setConverter(new StringToDoubleConverter());

		// Nominal Sin Aportes
		txtNominalWithoutContribution = new TextField();
		txtNominalWithoutContribution.setCaption("Nominal Sin Aportes");
		txtNominalWithoutContribution.setImmediate(false);
		txtNominalWithoutContribution.setWidth("-1px");
		txtNominalWithoutContribution.setHeight("-1px");
		txtNominalWithoutContribution.setNullRepresentation("");
		txtNominalWithoutContribution
				.setConverter(new StringToDoubleConverter());

		// Prevision Despido
		txtDismisalPrevension = new TextField();
		txtDismisalPrevension.setCaption("Prevision Despido");
		txtDismisalPrevension.setImmediate(false);
		txtDismisalPrevension.setWidth("-1px");
		txtDismisalPrevension.setHeight("-1px");
		txtDismisalPrevension.setNullRepresentation("");
		txtDismisalPrevension.setConverter(new StringToDoubleConverter());

		// Incidencia Sueldo
		txtIncidenceSalary = new TextField();
		txtIncidenceSalary.setCaption("Incidencia Sueldo");
		txtIncidenceSalary.setImmediate(false);
		txtIncidenceSalary.setWidth("-1px");
		txtIncidenceSalary.setHeight("-1px");
		txtIncidenceSalary.setNullRepresentation("");
		txtIncidenceSalary.setConverter(new StringToDoubleConverter());

		// Incidencia Tickets
		txtIncidenceTickets = new TextField();
		txtIncidenceTickets.setCaption("Incidencia Tickets");
		txtIncidenceTickets.setImmediate(true);
		txtIncidenceTickets.setWidth("-1px");
		txtIncidenceTickets.setHeight("-1px");
		txtIncidenceTickets.setNullRepresentation("");
		txtIncidenceTickets.setConverter(new StringToDoubleConverter());

		// Sueldos a Pagar
		txtSalaryToPay = new TextField();
		txtSalaryToPay.setCaption("Sueldos A Pagar");
		txtSalaryToPay.setImmediate(false);
		txtSalaryToPay.setWidth("-1px");
		txtSalaryToPay.setHeight("-1px");
		txtSalaryToPay.setNullRepresentation("");
		txtSalaryToPay.setConverter(new StringToDoubleConverter());

		// Costo Mensual
		txtCostMonth = new TextField();
		txtCostMonth.setCaption("Costo Mensual");
		txtCostMonth.setImmediate(false);
		txtCostMonth.setWidth("-1px");
		txtCostMonth.setHeight("-1px");
		txtCostMonth.setNullRepresentation("");
		txtCostMonth.setConverter(new StringToDoubleConverter());

		// Costo Hora Meerkat
		txtCostRealHour = new TextField();
		txtCostRealHour.setCaption("Costo Hora Meerkat");
		txtCostRealHour.setImmediate(false);
		txtCostRealHour.setWidth("-1px");
		txtCostRealHour.setHeight("-1px");
		txtCostRealHour.setNullRepresentation("");
		txtCostRealHour.setConverter(new StringToDoubleConverter());

		// Tipo empleado
		optEmployeeType = new OptionGroup();
		optEmployeeType.addItems("Empleado", "Socio");
		optEmployeeType.setCaption("Tipo");
		optEmployeeType.setImmediate(true);
		optEmployeeType.setWidth("-1px");
		optEmployeeType.setHeight("-1px");
		optEmployeeType.setRequired(true);

		// Boton Estimar
		btnEstimate = new Button();
		btnEstimate.setCaption("Estimar");
		btnEstimate.setImmediate(true);
		btnEstimate.setWidth("-1px");
		btnEstimate.setHeight("-1px");

		// TAB 1
		GridLayout tab1 = new GridLayout(2, 5);
		tab1.setSpacing(true);
		tab1.addComponent(txtName, 0, 0, 1, 0);
		tab1.addComponent(txtSurname, 0, 1, 1, 1);
		tab1.addComponent(txtAddress, 0, 2, 1, 2);
		tab1.addComponent(txtEmail, 0, 3, 1, 3);
		tab1.addComponent(txtCellphone, 0, 4);
		tab1.addComponent(optEmployeeType, 1, 4);
		tabEmployee.addTab(tab1, "Datos personales");

		// TAB 2
		GridLayout tab2 = new GridLayout(2, 5);
		tab2.setSpacing(true);
		tab2.addComponent(txtNominalSalary, 0, 0);
		tab2.addComponent(txtTickets, 1, 0);
		tab2.addComponent(cboPercentagePersonalFonasaContribution, 0, 1);
		tab2.addComponent(txtHours, 1, 1);
		tab2.addComponent(txtIrpf, 0, 2);
		tab2.addComponent(txtBse, 1, 2);
		tab2.addComponent(txtRet, 0, 3);
		tab2.addComponent(txtCostSaleHour, 1, 3);
		tab2.addComponent(btnEstimate, 0, 4);
		tabEmployee.addTab(tab2, "Costos 1");

		// TAB 3
		GridLayout tab3 = new GridLayout(2, 4);
		tab3.setSpacing(true);
		tab3.addComponent(txtPersonalRetirementContribution, 0, 0);
		tab3.addComponent(txtEmployerRetirementContribution, 1, 0);
		tab3.addComponent(txtPersonalFrlContribution, 0, 1);
		tab3.addComponent(txtEmployerFrlContribution, 1, 1);
		tab3.addComponent(txtPersonalFonasaContribution, 0, 2);
		tab3.addComponent(txtEmployerFonasaContribution, 1, 2);
		tab3.addComponent(txtTicketsEmployer, 0, 3);
		tab3.addComponent(txtTotalDiscounts, 1, 3);
		tabEmployee.addTab(tab3, "Costos 2");

		// TAB 4
		GridLayout tab4 = new GridLayout(2, 4);
		tab4.setSpacing(true);
		tab4.addComponent(txtTotalEmployersContribution, 0, 0);
		tab4.addComponent(txtNominalWithoutContribution, 1, 0);
		tab4.addComponent(txtIncidenceSalary, 0, 1);
		tab4.addComponent(txtIncidenceTickets, 1, 1);
		tab4.addComponent(txtDismisalPrevension, 0, 2);
		tab4.addComponent(txtCostMonth, 1, 2);
		tab4.addComponent(txtCostRealHour, 0, 3);
		tab4.addComponent(txtSalaryToPay, 1, 3);
		tabEmployee.addTab(tab4, "Costos 3");

		tabEmployee.setVisible(false);
	}

	@SuppressWarnings("serial")
	public void buildGrid() {
		Collection<Employee> employees = EmployeeController.GetEmployees();

		if (employees != null && employees.size() > 0) {
			btnCancel.setVisible(true);
			btnModiffy.setVisible(true);

			lblMessage.setValue("");
			beanContainer = new BeanItemContainer<Employee>(Employee.class,
					employees);

			updateEmployeesGrid = new Grid(beanContainer);
			updateEmployeesGrid.removeColumn("id");
			updateEmployeesGrid.removeColumn("updatedDateTimeUTC");
			updateEmployeesGrid.removeColumn("createdDateTimeUTC");
			updateEmployeesGrid.removeColumn("employedType");
			updateEmployeesGrid.removeColumn("user");
			updateEmployeesGrid.removeColumn("salarySummary");
			updateEmployeesGrid.removeColumn("salarySummaries");
			updateEmployeesGrid.removeColumn("email");
			updateEmployeesGrid.removeColumn("address");
			updateEmployeesGrid.removeColumn("cellPhone");

			updateEmployeesGrid.setColumnOrder("name", "lastName");

			updateEmployeesGrid.getColumn("name").setHeaderCaption("Nombre");
			updateEmployeesGrid.getColumn("lastName").setHeaderCaption(
					"Apellido");
			updateEmployeesGrid.setWidth(373, Unit.PIXELS);
			updateEmployeesGrid.setHeight(310, Unit.PIXELS);
			updateEmployeesGrid.setSelectionMode(SelectionMode.SINGLE);
			updateEmployeesGrid.getSelectedRows().clear();

			// Filtros
			HeaderRow filterRow = updateEmployeesGrid.appendHeaderRow();

			for (final Object pid : updateEmployeesGrid
					.getContainerDataSource().getContainerPropertyIds()) {
				HeaderCell cell = filterRow.getCell(pid);
				if (cell != null) {
					TextField txtFilter = new TextField();
					txtFilter.setImmediate(true);
					txtFilter.setWidth("125px");
					txtFilter.setHeight("30px");
					txtFilter.setInputPrompt("Filtro");

					txtFilter.addTextChangeListener(new TextChangeListener() {
						@Override
						public void textChange(TextChangeEvent event) {
							String newValue = (String) event.getText();

							@SuppressWarnings("unchecked")
							BeanItemContainer<Category> container = ((BeanItemContainer<Category>) updateEmployeesGrid
									.getContainerDataSource());

							container.removeContainerFilters(pid);
							if (null != newValue && !newValue.isEmpty()) {
								container
										.addContainerFilter(new SimpleStringFilter(
												pid, newValue, true, false));
							}
						}
					});
					cell.setComponent(txtFilter);
				}
			}
			mainLayout.addComponent(updateEmployeesGrid, "top:20%;left:0.0px;");

			updateEmployeesGrid.addSelectionListener(new SelectionListener() {

				@Override
				public void select(SelectionEvent event) {

					BeanItem<Employee> item = beanContainer
							.getItem(updateEmployeesGrid.getSelectedRow());
					if (item != null) {
						Employee selectedEmployee = item.getBean();
						loadEmployee(selectedEmployee);
						tabEmployee.setVisible(true);
						btnModiffy.setEnabled(true);
					} else {
						tabEmployee.setVisible(false);
						btnModiffy.setEnabled(false);
					}

				}

			});
		} else {
			lblMessage.setValue("No hay empleados para mostrar");
			if (updateEmployeesGrid != null) {
				updateEmployeesGrid.setVisible(false);
			}
			btnCancel.setVisible(false);
			btnModiffy.setVisible(false);
		}

	}

	public void changeReadOnlyState(boolean state) {
		txtPersonalRetirementContribution.setReadOnly(state);
		txtEmployerRetirementContribution.setReadOnly(state);
		txtPersonalFrlContribution.setReadOnly(state);
		txtEmployerFrlContribution.setReadOnly(state);
		txtPersonalFonasaContribution.setReadOnly(state);
		txtEmployerFonasaContribution.setReadOnly(state);
		txtTicketsEmployer.setReadOnly(state);
		txtTotalDiscounts.setReadOnly(state);
		txtTotalEmployersContribution.setReadOnly(state);
		txtNominalWithoutContribution.setReadOnly(state);
		txtDismisalPrevension.setReadOnly(state);
		txtIncidenceSalary.setReadOnly(state);
		txtSalaryToPay.setReadOnly(state);
		txtCostMonth.setReadOnly(state);
		txtCostRealHour.setReadOnly(state);
		txtIncidenceTickets.setReadOnly(state);

	}

	public void loadEmployee(Employee selectedEmployee) {

		// seteo en readonly false, para poder cargar los datos
		changeReadOnlyState(false);

		SalarySummary salarySummary = selectedEmployee.getSalarySummary();
		txtName.setValue(selectedEmployee.getName());
		txtSurname.setValue(selectedEmployee.getLastName());
		txtCellphone.setValue(selectedEmployee.getCellPhone());
		txtAddress.setValue(selectedEmployee.getAddress());
		txtEmail.setValue(selectedEmployee.getEmail());
		txtNominalSalary.setConvertedValue(salarySummary.getNominalSalary());
		txtTickets.setConvertedValue(salarySummary.getTickets());
		cboPercentagePersonalFonasaContribution.setValue(salarySummary
				.getPercentageTypeFONASA() * 100);
		txtRet.setConvertedValue(salarySummary.getRET());
		txtIrpf.setConvertedValue(salarySummary.getIRPF());
		txtBse.setConvertedValue(salarySummary.getBSE());
		txtHours.setConvertedValue(salarySummary.getHours());
		txtCostSaleHour.setConvertedValue(salarySummary.getCostSaleHour());
		txtPersonalRetirementContribution.setConvertedValue(salarySummary
				.getPersonalRetirementContribution());
		txtEmployerRetirementContribution.setConvertedValue(salarySummary
				.getEmployersContributionsRetirement());
		txtPersonalFrlContribution.setConvertedValue(salarySummary
				.getPersonalFRLContribution());
		txtEmployerFrlContribution.setConvertedValue(salarySummary
				.getEmployersFRLContribution());
		txtPersonalFonasaContribution.setConvertedValue(salarySummary
				.getPersonalFONASAContribution());
		txtEmployerFonasaContribution.setConvertedValue(salarySummary
				.getEmployersFONASAContribution());
		txtTicketsEmployer.setConvertedValue(salarySummary
				.getTicketsEmployers());
		txtTotalDiscounts.setConvertedValue(salarySummary.getTotalDiscounts());
		txtTotalEmployersContribution.setConvertedValue(salarySummary
				.getTotalEmployerContributions());
		txtNominalWithoutContribution.setConvertedValue(salarySummary
				.getNominalWithoutContributions());
		txtDismisalPrevension.setConvertedValue(salarySummary
				.getDismissalPrevention());
		txtIncidenceSalary
				.setConvertedValue(salarySummary.getIncidenceSalary());
		txtSalaryToPay.setConvertedValue(salarySummary.getSalaryToPay());
		txtCostMonth.setConvertedValue(salarySummary.getCostMonth());
		txtCostRealHour.setConvertedValue(salarySummary.getCostRealHour());
		txtIncidenceTickets.setConvertedValue(salarySummary
				.getIncidenceTickets());
		optEmployeeType.select(selectedEmployee.getEmployedType());
		// seteo en readonly false los campos del empleado a mostrar
		changeReadOnlyState(true);

	}

	@Override
	public void enter(ViewChangeEvent event) {
		super.enter(event);
		if (RequestContext.getRequestContext() != null) {
			// Compruebo si el usuario es de tipo socio
			if (RequestContext.getRequestContext().getUserType() != 2) {
				getUI().getNavigator().navigateTo(WebvaadinUI.MAINMENU);
			}
			if (updateEmployeesGrid != null) {
				mainLayout.removeComponent(updateEmployeesGrid);
			}
			buildGrid();
			tabEmployee.setVisible(false);
			btnModiffy.setEnabled(false);
		}

	}

	@AutoGenerated
	private AbsoluteLayout buildMainLayout() {
		// common part: create layout
		mainLayout = new AbsoluteLayout();
		mainLayout.setImmediate(false);
		mainLayout.setWidth("1083px");
		mainLayout.setHeight("500px");

		// top-level component properties
		setWidth("1083px");
		setHeight("500px");

		// lblTitle
		lblTitle = new Label();
		lblTitle.setStyleName("titleLabel");
		lblTitle.setImmediate(false);
		lblTitle.setWidth("-1px");
		lblTitle.setHeight("-1px");
		lblTitle.setValue("Modificar empleados");
		mainLayout.addComponent(lblTitle, "top:42.0px;left:0.0px;");

		// tabEmployee
		tabEmployee = new TabSheet();
		tabEmployee.setCaption("Datos del empleado");
		tabEmployee.setImmediate(false);
		tabEmployee.setWidth("-1px");
		tabEmployee.setHeight("-1px");
		mainLayout.addComponent(tabEmployee, "top:80.0px;left:400.0px;");

		// btnCreate
		btnModiffy = new Button();
		btnModiffy.setCaption("Modificar");
		btnModiffy.setImmediate(true);
		btnModiffy.setWidth("-1px");
		btnModiffy.setHeight("-1px");
		mainLayout.addComponent(btnModiffy, "top:414.0px;left:0.0px;");

		// btnCancel
		btnCancel = new Button();
		btnCancel.setCaption("Cancelar");
		btnCancel.setImmediate(true);
		btnCancel.setWidth("-1px");
		btnCancel.setHeight("-1px");
		mainLayout.addComponent(btnCancel, "top:414.0px;left:120.0px;");

		return mainLayout;
	}

}
