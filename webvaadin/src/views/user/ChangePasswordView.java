package views.user;

import utils.PopupWindow;
import views.BaseView;

import com.example.webvaadin.WebvaadinUI;
import com.vaadin.annotations.AutoGenerated;
import com.vaadin.navigator.ViewChangeListener.ViewChangeEvent;
import com.vaadin.server.Page;
import com.vaadin.ui.AbsoluteLayout;
import com.vaadin.ui.Button;
import com.vaadin.ui.Button.ClickEvent;
import com.vaadin.ui.Label;
import com.vaadin.ui.PasswordField;

import controllers.UserController;
import entities.RequestContext;

public class ChangePasswordView extends BaseView {

	/*- VaadinEditorProperties={"grid":"RegularGrid,20","showGrid":true,"snapToGrid":true,"snapToObject":true,"movingGuides":false,"snappingDistance":10} */

	@AutoGenerated
	private AbsoluteLayout mainLayout;
	@AutoGenerated
	private Button btnCancel;
	@AutoGenerated
	private Button btnModify;
	@AutoGenerated
	private PasswordField confirmPassword;
	@AutoGenerated
	private PasswordField newPassword;
	@AutoGenerated
	private PasswordField oldPassword;
	@AutoGenerated
	private Label lblTitle;
	private int idUser;


	public ChangePasswordView() {
		buildMainLayout();
		setCompositionRoot(mainLayout);
				
		btnModify.addClickListener(new Button.ClickListener() {

			@Override
			public void buttonClick(ClickEvent event) {
				if(changePasswordValidate()){
					UserController userController = new UserController();
					if(userController.changePassword(idUser, oldPassword.getValue(), newPassword.getValue())){
						PopupWindow popup = new PopupWindow("AVISO", "Constraseña modificada correctamente");
						//limpio los campos
						oldPassword.setValue("");
						newPassword.setValue("");
						confirmPassword.setValue("");
						getUI().getNavigator().navigateTo(WebvaadinUI.MAINMENU);
					}
				}
			}
		});
		
		btnCancel.addClickListener(new Button.ClickListener() {

			@Override
			public void buttonClick(ClickEvent event) {
				getUI().getNavigator().navigateTo(WebvaadinUI.MAINMENU);				
			}
		});
	}

	@Override
	public void enter(ViewChangeEvent event) {
		super.enter(event);
		if (RequestContext.getRequestContext() != null) {
			oldPassword.focus();
			idUser = RequestContext.getRequestContext().getId();
		}
	}

	public boolean changePasswordValidate() {
		boolean validate = true;
		String errors = "";
		
		String oldPasswordLabel = oldPassword.getValue();
		if (oldPasswordLabel.isEmpty()) {
			validate = false;
			errors += "Debes ingresar la contraseña actual\n";
		}

		String newPasswordLabel = newPassword.getValue();
		if (newPasswordLabel.isEmpty()) {
			validate = false;
			errors += "Debes ingresar la contraseña nueva\n";
		}
		
		String confirmPasswordLabel = confirmPassword.getValue();
		if (confirmPasswordLabel.isEmpty()) {
			validate = false;
			errors += "Debes ingresar la confirmación de la nueva contraseña\n";
		}
		
		if(!newPasswordLabel.isEmpty() && !confirmPasswordLabel.isEmpty() 
				&& !newPasswordLabel.equals(confirmPasswordLabel)){
			validate = false;
			errors += "La nueva contraseña y su confirmación no coinciden\n";
		}
		
		if (!validate) {
			PopupWindow popup = new PopupWindow("ERROR", errors);
		}
		return validate;
	}

	@AutoGenerated
	private AbsoluteLayout buildMainLayout() {
		// common part: create layout
		mainLayout = new AbsoluteLayout();
		mainLayout.setImmediate(false);
		mainLayout.setWidth("682px");
		mainLayout.setHeight("570px");
		
		// top-level component properties
		setWidth("682px");
		setHeight("570px");
		
		// lblTitle
		lblTitle = new Label();
		lblTitle.setStyleName("titleLabel");
		lblTitle.setImmediate(false);
		lblTitle.setWidth("-1px");
		lblTitle.setHeight("-1px");
		lblTitle.setValue("Cambiar contraeña");
		mainLayout.addComponent(lblTitle, "top:42.0px;left:0.0px;");
		
		// oldPassword
		oldPassword = new PasswordField();
		oldPassword.setCaption("Contraseña actual");
		oldPassword.setImmediate(false);
		oldPassword.setWidth("240px");
		oldPassword.setHeight("-1px");
		oldPassword.setTabIndex(1);
		mainLayout.addComponent(oldPassword, "top:120.0px;left:0.0px;");
		
		// newPassword
		newPassword = new PasswordField();
		newPassword.setCaption("Contraseña nueva");
		newPassword.setImmediate(false);
		newPassword.setWidth("240px");
		newPassword.setHeight("-1px");
		newPassword.setTabIndex(2);
		mainLayout.addComponent(newPassword, "top:190.0px;left:0.0px;");
		
		// confirmPassword
		confirmPassword = new PasswordField();
		confirmPassword.setCaption("Confirmación de la nueva contraseña");
		confirmPassword.setImmediate(false);
		confirmPassword.setWidth("240px");
		confirmPassword.setHeight("-1px");
		confirmPassword.setTabIndex(2);
		mainLayout.addComponent(confirmPassword, "top:260.0px;left:0.0px;");
		
		// btnModify
		btnModify = new Button();
		btnModify.setCaption("Modificar");
		btnModify.setImmediate(true);
		btnModify.setWidth("100px");
		btnModify.setHeight("-1px");
		btnModify.setTabIndex(3);
		mainLayout.addComponent(btnModify, "top:330.0px;left:0.0px;");
		
		// btnCancel
		btnCancel = new Button();
		btnCancel.setCaption("Cancelar");
		btnCancel.setImmediate(true);
		btnCancel.setWidth("100px");
		btnCancel.setHeight("-1px");
		btnCancel.setTabIndex(4);
		mainLayout.addComponent(btnCancel, "top:330.0px;left:140.0px;");
		
		return mainLayout;
	}
}
